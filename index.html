<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budget ‚Äì Courses & Fixe</title>
  <meta name="theme-color" content="#8ba5ff" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <!-- Splash screen iOS -->
<link rel="apple-touch-startup-image" href="icons/splash-512x1024.png" 
media="(device-width: 375px) and (device-height: 812px) 
       and (-webkit-device-pixel-ratio: 3)" />

  <style>
    /* ‚Äî‚Äî‚Äî Th√®me "chill japan" ‚Äî‚Äî‚Äî
       Palette douce, motifs vagues (seigaiha), bords arrondis, ombres l√©g√®res. */
    :root{
      --bg:#0c1020;            /* nuit indigo */
      --bg2:#0e1328;           /* carte */
      --ink:#eaf0ff;           /* texte */
      --muted:#93a0c6;         /* secondaire */
      --brand:#8ba5ff;         /* accent pastel indigo */
      --accent:#ffd4e5;        /* rose sakura */
      --good:#11c59c;          /* jade */
      --bad:#ff6b6b;           /* corail */
      --line:rgba(255,255,255,.09);
      --shadow:0 10px 30px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background: radial-gradient(1000px 600px at 90% -10%, rgba(139,165,255,.18), transparent 60%), var(--bg);
    }
    /* Motif vagues en pseudo-√©l√©ment */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.12;
      background-image:
        radial-gradient(ellipse at 20% -10%, rgba(255,212,229,.35), transparent 40%),
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="80" viewBox="0 0 160 80"><defs><pattern id="s" width="40" height="20" patternUnits="userSpaceOnUse"><path d="M0 10q10-10 20 0t20 0 20 0 20 0 20 0" fill="none" stroke="%23ffffff" stroke-opacity="0.25" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23s)"/></svg>');
      background-size: cover, 160px 80px;
      mix-blend-mode: screen;
    }

    .wrap{max-width:1040px; margin:0 auto; padding:24px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:36px; height:36px; border-radius:12px; background:linear-gradient(135deg, var(--brand), var(--accent)); box-shadow: var(--shadow)}
    .title{font-weight:900; letter-spacing:.2px; font-size:clamp(22px,4vw,28px)}

    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{border:1px solid var(--line); background:linear-gradient(180deg, rgba(139,165,255,.15), rgba(139,165,255,.05)); color:var(--ink); padding:10px 14px; border-radius:12px; cursor:pointer}
    .tab[aria-selected="true"]{outline:2px solid rgba(139,165,255,.5); background:linear-gradient(180deg, rgba(255,212,229,.18), rgba(139,165,255,.08))}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0)); border:1px solid var(--line); border-radius:18px; padding:16px; box-shadow: var(--shadow)}
    .grid{display:grid; gap:14px}
    .grid-2{grid-template-columns:1fr}
    @media(min-width:900px){ .grid-2{grid-template-columns:1.15fr .85fr} }

    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px}
    input, button, select{font:inherit; color:inherit}
    input[type="number"], input[type="text"], input[type="date"], input[type="month"], select{
      width:100%; border-radius:12px; border:1px solid var(--line); background:#0f1730; padding:12px 14px; outline:none; transition:border .15s, box-shadow .15s
    }
    input:focus, select:focus{border-color:var(--brand); box-shadow:0 0 0 3px rgba(139,165,255,.25)}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .btn{display:inline-flex; align-items:center; gap:8px; border:1px solid var(--line); background:linear-gradient(180deg, rgba(139,165,255,.18), rgba(139,165,255,.05)); padding:10px 14px; border-radius:12px; cursor:pointer}
    .btn.secondary{background:transparent}
    .btn.danger{background:linear-gradient(180deg, rgba(255,107,107,.22), rgba(255,107,107,.06)); border-color: rgba(255,107,107,.55)}
    .btn.small{padding:6px 10px; font-size:13px}

    .kpis{display:grid; grid-template-columns:repeat(3, 1fr); gap:12px}
    .kpi{background:#0f1730; border:1px solid var(--line); border-radius:12px; padding:12px}
    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .value{font-weight:800; font-size:20px}

    .progress{height:12px; background:#0f1730; border:1px solid var(--line); border-radius:999px; overflow:hidden}
    .bar{height:100%; background:linear-gradient(90deg, var(--brand), var(--accent)); width:0%}

    .list{display:grid; gap:10px}
    .item{display:grid; grid-template-columns:auto 1fr auto auto; gap:10px; align-items:center; padding:10px 12px; border-radius:12px; background:#0f1730; border:1px solid var(--line)}
    .item .date{font-size:12px; color:var(--muted)}
    .item .label{font-weight:600}
    .item .amount{font-variant-numeric: tabular-nums; font-weight:700}

    .table{width:100%; border-collapse:separate; border-spacing:0 8px}
    .table th{color:var(--muted); font-size:12px; text-align:left; padding:0 8px}
    .table td{background:#0f1730; border:1px solid var(--line); padding:8px; border-left:none; border-right:none}
    .table td:first-child{border-left:1px solid var(--line); border-radius:12px 0 0 12px}
    .table td:last-child{border-right:1px solid var(--line); border-radius:0 12px 12px 0}

    .muted{color:var(--muted)}
    .pill{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.02)}
    footer{opacity:.8; font-size:12px; margin-top:18px; color:var(--muted)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">Budget ‚Äì Courses & Fixe</div>
      </div>
      <nav class="tabs" role="tablist">
        <button class="tab" id="tab-courses" role="tab" aria-controls="panel-courses" aria-selected="true">üß∫ Courses</button>
        <button class="tab" id="tab-fixe" role="tab" aria-controls="panel-fixe" aria-selected="false">üè† D√©penses fixes</button>
        <button class="tab secondary" id="exportBtn">‚¨áÔ∏è Export</button>
        <label class="tab secondary" for="importFile">‚¨ÜÔ∏è Import</label>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </nav>
    </header>

    <!-- ===== PANEL COURSES ===== -->
    <section id="panel-courses" class="grid grid-2" role="tabpanel" aria-labelledby="tab-courses">
      <section class="card">
        <div class="row">
          <div>
            <label for="c-month">Mois</label>
            <input type="month" id="c-month" />
          </div>
          <div>
            <label for="c-budget">Budget du mois (‚Ç¨)</label>
            <div class="row" style="grid-template-columns:1fr auto; gap:8px">
              <input id="c-budget" type="number" step="0.01" min="0" placeholder="300" />
              <button class="btn" id="c-saveBudget">üíæ</button>
            </div>
          </div>
        </div>

        <div class="kpis" style="margin-top:12px">
          <div class="kpi"><div class="label">Budget</div><div class="value" id="c-kpiBudget">‚Äî</div></div>
          <div class="kpi"><div class="label">D√©pens√©</div><div class="value" id="c-kpiSpent">‚Äî</div></div>
          <div class="kpi"><div class="label">Restant</div><div class="value" id="c-kpiLeft">‚Äî</div></div>
        </div>

        <div class="progress" style="margin-top:8px"><div class="bar" id="c-bar"></div></div>
        <div class="muted" id="c-hint" style="margin-top:6px"></div>

        <h3 style="margin:14px 0 8px; font-size:16px">Ajouter un ticket</h3>
        <div class="row">
          <div>
            <label for="c-amount">Montant (‚Ç¨)</label>
            <input id="c-amount" type="number" step="0.01" min="0.01" placeholder="35.60" />
          </div>
          <div>
            <label for="c-label">Libell√© (optionnel)</label>
            <input id="c-label" type="text" placeholder="Ex: Carrefour, fruits‚Ä¶" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label for="c-date">Date</label>
            <input id="c-date" type="date" />
          </div>
          <div style="display:flex; align-items:flex-end;">
            <button class="btn" id="c-add">+ Ajouter</button>
          </div>
        </div>

        <div style="display:flex; gap:8px; align-items:center; margin-top:10px">
          <span class="pill" id="c-monthInfo">‚Äî</span>
          <button class="btn danger" id="c-reset">R√©initialiser le mois</button>
        </div>
      </section>

      <section class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:6px">
          <h3 style="margin:0; font-size:16px">D√©penses du mois</h3>
          <span class="muted" id="c-count">0 √©l√©ment</span>
        </div>
        <div class="list" id="c-list"></div>
        <footer>‚úèÔ∏è pour modifier, üóëÔ∏è pour supprimer. Donn√©es uniquement sur cet appareil (localStorage).</footer>
      </section>
    </section>

    <!-- ===== PANEL FIXE ===== -->
    <section id="panel-fixe" class="hidden" role="tabpanel" aria-labelledby="tab-fixe">
      <section class="card" style="margin-bottom:16px">
        <div class="row">
          <div>
            <label for="f-month">Mois</label>
            <input type="month" id="f-month" />
          </div>
          <div>
            <label for="f-income">Revenus du mois (‚Ç¨)</label>
            <input type="number" id="f-income" step="0.01" placeholder="2000" />
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <div>
            <label for="f-savings">Objectif √©pargne (‚Ç¨)</label>
            <input type="number" id="f-savings" step="0.01" placeholder="700" />
          </div>
          <div style="display:flex;align-items:flex-end;gap:8px">
            <button class="btn" id="f-saveHead">üíæ Enregistrer</button>
            <button class="btn danger" id="f-reset">R√©initialiser le mois</button>
          </div>
        </div>
      </section>

      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <h3 style="margin:0;font-size:16px">D√©penses fixes</h3>
          <button class="btn" id="f-addRow">+ Ajouter une ligne</button>
        </div>
        <table class="table">
          <thead>
            <tr><th style="width:40%">Libell√©</th><th style="width:25%">Cat√©gorie</th><th style="width:25%">Montant (‚Ç¨)</th><th style="width:10%"></th></tr>
          </thead>
          <tbody id="f-tbody"></tbody>
        </table>

        <div class="kpis">
          <div class="kpi"><div class="label">Revenus</div><div class="value" id="f-kIncome">‚Äî</div></div>
          <div class="kpi"><div class="label">D√©penses fixes</div><div class="value" id="f-kFixed">‚Äî</div></div>
          <div class="kpi"><div class="label">Reste apr√®s d√©penses</div><div class="value" id="f-kAfter">‚Äî</div></div>
        </div>
        <div class="kpis" style="margin-top:12px">
          <div class="kpi"><div class="label">Objectif √©pargne</div><div class="value" id="f-kSav">‚Äî</div></div>
          <div class="kpi"><div class="label">Reste apr√®s √©pargne</div><div class="value" id="f-kLeft" style="color:var(--good)">‚Äî</div></div>
          <div class="kpi"><div class="label">√âtat</div><div class="value" id="f-kStatus">‚Äî</div></div>
        </div>
      </section>
    </section>

    <footer style="margin-top:16px">Tout est stock√© en local (localStorage). Export/Import pour sauvegarder. PWA installable (manifest + service worker).</footer>
  </div>

  <script>
  // ====== Utilitaires & √©tat global ======
  const EUR = new Intl.NumberFormat('fr-FR',{style:'currency', currency:'EUR'});
  const todayISO = ()=> new Date().toISOString().slice(0,10);
  const toMonthKey = (dateISO)=> (dateISO || todayISO()).slice(0,7);
  const APPKEY = 'budgetUnified_v1';
  let app = load();
  function load(){ try{ const raw = localStorage.getItem(APPKEY); if(raw) return JSON.parse(raw);}catch{} return { view:'courses', courses:{defaultBudget:300, months:{}}, fixe:{months:{}} }; }
  function save(){ localStorage.setItem(APPKEY, JSON.stringify(app)); }

  // ====== Tabs ======
  const tabCourses = document.getElementById('tab-courses');
  const tabFixe = document.getElementById('tab-fixe');
  const panelCourses = document.getElementById('panel-courses');
  const panelFixe = document.getElementById('panel-fixe');
  function switchTab(name){
    const isCourses = name==='courses';
    tabCourses.setAttribute('aria-selected', String(isCourses));
    tabFixe.setAttribute('aria-selected', String(!isCourses));
    panelCourses.classList.toggle('hidden', !isCourses);
    panelFixe.classList.toggle('hidden', isCourses);
    app.view = name; save();
  }

  // ====== COURSES ======
  const cMonth = document.getElementById('c-month');
  const cBudget = document.getElementById('c-budget');
  const cSaveBudget = document.getElementById('c-saveBudget');
  const cAmount = document.getElementById('c-amount');
  const cLabel = document.getElementById('c-label');
  const cDate = document.getElementById('c-date');
  const cAdd = document.getElementById('c-add');
  const cList = document.getElementById('c-list');
  const cKpiBudget = document.getElementById('c-kpiBudget');
  const cKpiSpent = document.getElementById('c-kpiSpent');
  const cKpiLeft = document.getElementById('c-kpiLeft');
  const cBar = document.getElementById('c-bar');
  const cHint = document.getElementById('c-hint');
  const cCount = document.getElementById('c-count');
  const cMonthInfo = document.getElementById('c-monthInfo');
  const cReset = document.getElementById('c-reset');

  let cCurrent = toMonthKey();
  function cEnsure(m){ if(!app.courses.months[m]){ app.courses.months[m] = { budget: app.courses.defaultBudget||300, expenses: [] }; save(); } }
  function cRender(){
    cEnsure(cCurrent);
    const m = app.courses.months[cCurrent];
    cMonth.value = cCurrent;
    cBudget.value = Number(m.budget)||'';
    cDate.value = cDate.value || todayISO();

    const spent = m.expenses.reduce((s,e)=> s + Number(e.amount||0), 0);
    const left = (Number(m.budget)||0) - spent;
    cKpiBudget.textContent = EUR.format(Number(m.budget)||0);
    cKpiSpent.textContent = EUR.format(spent);
    cKpiLeft.textContent = EUR.format(left);
    cKpiLeft.style.color = left>=0 ? 'var(--good)' : 'var(--bad)';
    const pct = (Number(m.budget)>0) ? Math.min(100, Math.max(0, (spent/Number(m.budget))*100)) : 0;
    cBar.style.width = pct + '%';
    cHint.textContent = left>=0 ? `Il reste ${EUR.format(left)} sur ${EUR.format(m.budget)}.` : `D√©passement de ${EUR.format(-left)}.`;

    // Liste
    cList.innerHTML='';
    const sorted = [...m.expenses].sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    sorted.forEach(e=> cList.appendChild(cRow(e)));
    cCount.textContent = `${sorted.length} ${sorted.length>1?'√©l√©ments':'√©l√©ment'}`;

    // Mois badge
    const dt = new Date(cCurrent+"-01T00:00:00");
    cMonthInfo.textContent = dt.toLocaleDateString('fr-FR',{month:'long', year:'numeric'});
  }
  function cRow(e){
    const row = document.createElement('div'); row.className='item';
    const d = document.createElement('div'); d.className='date muted'; d.textContent = fmtDate(e.date);
    const lab = document.createElement('div'); lab.className='label'; lab.textContent = e.label || '‚Äî';
    const amt = document.createElement('div'); amt.className='amount'; amt.textContent = '‚àí ' + EUR.format(Number(e.amount)||0);
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
    const editBtn = document.createElement('button'); editBtn.className='btn small secondary'; editBtn.textContent='‚úèÔ∏è';
    const delBtn = document.createElement('button'); delBtn.className='btn small danger'; delBtn.textContent='üóëÔ∏è';
    editBtn.addEventListener('click', ()=> cEdit(e.id));
    delBtn.addEventListener('click', ()=> cDel(e.id));
    actions.append(editBtn, delBtn);
    row.append(d, lab, amt, actions);
    return row;
  }
  function fmtDate(iso){ try{ const d=new Date(iso||todayISO()); return d.toLocaleDateString('fr-FR',{day:'2-digit',month:'short'}).replace('.', ''); }catch{ return iso||'' } }
  function cSetMonth(v){ if(/^\d{4}-\d{2}$/.test(v)){ cCurrent=v; cRender(); } }
  function cSetBudget(){ const v=Number(cBudget.value); if(!isFinite(v)||v<0){ alert('Entre un budget valide.'); return } cEnsure(cCurrent); app.courses.months[cCurrent].budget=+v.toFixed(2); if(confirm('Utiliser ce montant comme budget par d√©faut ?')) app.courses.defaultBudget=+v.toFixed(2); save(); cRender(); }
  function cAddExpense(){ const amt=Number(cAmount.value); if(!isFinite(amt)||amt<=0){ alert('Montant invalide'); return } const label=(cLabel.value||'').trim(); const date=(cDate.value||todayISO()); const id=uid(); cEnsure(cCurrent); app.courses.months[cCurrent].expenses.push({id, amount:+amt.toFixed(2), label, date}); save(); cAmount.value=''; cLabel.value=''; cDate.value=todayISO(); cRender(); }
  function cDel(id){ const m=app.courses.months[cCurrent]; const i=m.expenses.findIndex(x=>x.id===id); if(i>=0 && confirm('Supprimer ?')){ m.expenses.splice(i,1); save(); cRender(); } }
  function cEdit(id){ const m=app.courses.months[cCurrent]; const it=m.expenses.find(x=>x.id===id); if(!it) return; const newAmt=prompt('Nouveau montant (‚Ç¨):', String(it.amount)); if(newAmt===null)return; const v=Number(newAmt); if(!isFinite(v)||v<=0){ alert('Montant invalide'); return } const newLabel=prompt('Nouveau libell√©:', it.label||''); const newDate=prompt('Nouvelle date (AAAA-MM-JJ):', it.date||todayISO()); if(newDate && /^\d{4}-\d{2}-\d{2}$/.test(newDate)) it.date=newDate; it.amount=+v.toFixed(2); it.label=(newLabel||'').trim(); save(); cRender(); }
  function cResetMonth(){ if(confirm('Effacer toutes les d√©penses de ce mois ?')){ cEnsure(cCurrent); app.courses.months[cCurrent].expenses=[]; save(); cRender(); } }

  // ====== FIXE ======
  const fMonth = document.getElementById('f-month');
  const fIncome = document.getElementById('f-income');
  const fSavings = document.getElementById('f-savings');
  const fSaveHead = document.getElementById('f-saveHead');
  const fReset = document.getElementById('f-reset');
  const fAddRow = document.getElementById('f-addRow');
  const fTbody = document.getElementById('f-tbody');
  const fkIncome = document.getElementById('f-kIncome');
  const fkFixed = document.getElementById('f-kFixed');
  const fkAfter = document.getElementById('f-kAfter');
  const fkSav = document.getElementById('f-kSav');
  const fkLeft = document.getElementById('f-kLeft');
  const fkStatus = document.getElementById('f-kStatus');

  let fCurrent = toMonthKey();
  function fEnsure(m){ if(!app.fixe.months[m]){ app.fixe.months[m] = { income:0, savings:0, rows:[] }; save(); } }
  function fRender(){
    fEnsure(fCurrent);
    const m = app.fixe.months[fCurrent];
    fMonth.value = fCurrent;
    fIncome.value = m.income || '';
    fSavings.value = m.savings || '';

    fTbody.innerHTML='';
    m.rows.forEach(row=> fTbody.appendChild(fRow(row)));
    const total = m.rows.reduce((s,r)=> s + (Number(r.amount)||0), 0);
    const after = (Number(m.income)||0) - total;
    const left = after - (Number(m.savings)||0);

    fkIncome.textContent = EUR.format(Number(m.income)||0);
    fkFixed.textContent = EUR.format(total);
    fkAfter.textContent = EUR.format(after);
    fkSav.textContent = EUR.format(Number(m.savings)||0);
    fkLeft.textContent = EUR.format(left);
    fkLeft.style.color = left>=0 ? 'var(--good)' : 'var(--bad)';
    fkStatus.textContent = left>=0 ? 'OK ‚úÖ' : 'D√©passement ‚ùå';
  }
  function fRow(row){
    const tr=document.createElement('tr');
    const tdL=document.createElement('td'); const tdC=document.createElement('td'); const tdA=document.createElement('td'); const tdX=document.createElement('td');
    const iL=document.createElement('input'); iL.type='text'; iL.placeholder='Loyer, Assurance‚Ä¶'; iL.value=row.label||'';
    const iC=document.createElement('input'); iC.type='text'; iC.placeholder='Maison, Banque‚Ä¶'; iC.value=row.category||'';
    const iA=document.createElement('input'); iA.type='number'; iA.step='0.01'; iA.min='0'; iA.value=row.amount ?? '';
    iA.style='text-align:right;width:100%;border-radius:12px;border:1px solid var(--line);background:#0f1730;padding:12px 14px;outline:none';
    iL.addEventListener('input', ()=>{ row.label=iL.value; persist(); });
    iC.addEventListener('input', ()=>{ row.category=iC.value; persist(); });
    iA.addEventListener('input', ()=>{ row.amount = toNum(iA.value); persist(); });
    const del=document.createElement('button'); del.className='btn danger'; del.textContent='üóëÔ∏è'; del.addEventListener('click', ()=>{ fDel(row.id) });
    tdL.appendChild(iL); tdC.appendChild(iC); tdA.appendChild(iA); tdX.appendChild(del);
    tr.append(tdL, tdC, tdA, tdX); return tr;
  }
  function toNum(v){ const n=Number(v); return isFinite(n)? +n.toFixed(2) : 0; }
  function fAdd(){ const m=app.fixe.months[fCurrent]; m.rows.push({id:uid(), label:'', category:'', amount:0}); persist(); }
  function fDel(id){ const m=app.fixe.months[fCurrent]; m.rows=m.rows.filter(r=> r.id!==id); persist(); }
  function fSaveHeadVals(){ const m=app.fixe.months[fCurrent]; m.income=toNum(fIncome.value); m.savings=toNum(fSavings.value); persist(); }
  function fResetMonth(){ if(confirm('Effacer toutes les lignes de ce mois ?')){ app.fixe.months[fCurrent].rows=[]; persist(); } }

  // ====== Export / Import global ======
  const exportBtn = document.getElementById('exportBtn');
  const importFile = document.getElementById('importFile');
  function doExport(){ const blob=new Blob([JSON.stringify(app,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='budget-unifie.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000); }
  function doImport(file){ const r=new FileReader(); r.onload=()=>{ try{ const incoming=JSON.parse(r.result); if(!incoming||!incoming.courses||!incoming.fixe) throw new Error('Format invalide'); app=incoming; save(); cRender(); fRender(); alert('Import r√©ussi ‚úÖ'); }catch(e){ alert('√âchec import : '+(e.message||e)); } }; r.readAsText(file); }

  // ====== Helpers ======
  function uid(){ return Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,7) }
  function persist(){ save(); cRender(); fRender(); }

  // ====== Init ======
  function init(){
    // Tabs
    tabCourses.addEventListener('click', ()=> switchTab('courses'));
    tabFixe.addEventListener('click', ()=> switchTab('fixe'));
    switchTab(app.view||'courses');

    // COURSES
    cCurrent = toMonthKey();
    cMonth.value=cCurrent; cDate.value=todayISO();
    cMonth.addEventListener('change', e=> cSetMonth(e.target.value));
    cSaveBudget.addEventListener('click', cSetBudget);
    cAdd.addEventListener('click', cAddExpense);
    cAmount.addEventListener('keydown', (e)=>{ if(e.key==='Enter') cAddExpense(); });
    cReset.addEventListener('click', cResetMonth);

    // FIXE
    fCurrent = toMonthKey();
    fMonth.addEventListener('change', e=>{ const v=e.target.value; if(/^\d{4}-\d{2}$/.test(v)){ fCurrent=v; fRender(); }});
    fAddRow.addEventListener('click', fAdd);
    fSaveHead.addEventListener('click', fSaveHeadVals);
    fReset.addEventListener('click', fResetMonth);

    // Export/Import
    exportBtn.addEventListener('click', doExport);
    importFile.addEventListener('change', (e)=>{ if(e.target.files && e.target.files[0]) doImport(e.target.files[0]); e.target.value=''; });

    // First render
    cRender(); fRender();
  }

  if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(console.error)); }
  init();
  </script>
</body>
</html>
